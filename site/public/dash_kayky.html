<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedConnect | Dashboard </title>

    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/dash-visu-rede.css">
    <!-- <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script> -->

    <link rel="shortcut icon" href="../Img/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <script src="js/graficoMaquinas.js"></script>
    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/validacoesUsuario.js"></script>
    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <div class="principal">
        <div class="sidebar">
            <div class="content-sidebar">
                <div class="logo-sidebar">
                    <img src="../Img/logo horizontal sem fundo.png" alt="">
                </div>

                <div class="options-sidebar">
                    <div class="opt">
                        <img src="../Img/icons8-gráfico-combinado-30.png" alt="">
                        <a href="dashboard.html">Dashboard Geral</a>
                    </div>

                    <div style="position: relative;" class="opt" id="aqui">
                        <img src="../Img/icons8-robô-48.png" alt="">
                        <a href="#">Dashboard Rôbos</a>
                        <img onclick="mostrarMenu()" style="margin-left: 7px; cursor: pointer;" src="./Img/icons8-mais-40.png" alt="">
                        <div style="display: none;" id="drop_menu" class="drop-menu">
                            <div class="item-menu">
                                <a href="dash_bianca.html">Dash Bianca</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_boos.html">Dash Boos</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_enzo.html">Dash Enzo</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_kayky.html">Dash Kayky</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_danilo.html">Dash Danilo</a>
                            </div>
                        </div>
                    </div>

                    <div class="opt" id="gerenciarUsuarios">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="dash-gerenciar-users.html">Gerenciar Usuários</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="perfil.html">Perfil</a>
                    </div>

                    <div class="opt" id="gerenciar-cirurgias">
                        <img src="Img/icons8-hospital-50.png" id="diminuir" alt="">
                        <a href="cadastrar-cirurgia.html">Gerenciar Cirurgia</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-assistente-48.png" alt="">
                        <a href="dash-suporte.html">Suporte</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-alerta-30.png" alt="">
                        <a href="#">Chamado</a>
                    </div>
                </div>

                <div class="quit-button">
                    <div class="opt">
                        <img src="../Img/icons8-sair-30.png" alt="">
                        <a href="index.html" onclick="deslogar()">Log Out</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" style="height: fit-content;">

            <div class="header-content">
                <div class="navbar-header" style="height: 10vh;">
                    <h3>Visualização de Rede</h3>
                    <p>Olá, <span style="font-weight: bolder;" id="b_usuario"></span></p>
                </div>
            </div>
            <div class="header-before2">
                <div class="maquinas" style="height: 85vh;">
                    <div class="content-rede">
                        <div class="container-grafico">
                            <div class="box-grafico">
                                <div class="header-grafico">
                                    <span class="span-grafico">Latência em Milissegundos</span>
                                </div>
                            </div>
                        </div>
                        <div class="container-grafico">
                            <div class="box-grafico">
                                <div class="header-grafico">
                                    <span class="span-grafico">Velocidade da Rede em MB/s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="content-kpi">
                        <div class="container-estabilidade">
                            <div class="box-estabilidade">
                                <div class="container-wifi">
                                    <img src="./Img/wifi.webp" alt="">
                                </div>
                                <div class="container-text-estabilidade">
                                    <span id="span-title">Estado da Rede</span>
                                    <span id="span-connection">Estável</span>
                                </div>
                            </div>
                        </div>
                        <div class="container-relatorio">
                            <div class="box-relatorio">
                                <div class="box-header-kpi">
                                    <span class="span-kpi">Relatório Geral</span>
                                </div>
                                <div class="box-kpi-data">
                                    <div class="div-title">
                                        <span>Latência</span>
                                        <span>Velocidade de Rede</span>
                                    </div>
                                    <div class="div-data">
                                        <span id="latencia">200ms</span>
                                        <span id="velocidadeRede">100 MB/s</span>
                                    </div>
                                    <div class="div-title">
                                        <span>Bytes Enviados</span>
                                        <span>Bytes Recebidos</span>
                                    </div>
                                    <div class="div-data">
                                        <span id="bytesEnviados">212312321</span>
                                        <span id="bytesRecebidos">3213212</span>
                                    </div>
                                </div>
                            </div>
                            <div class="container-select">
                                <div class="box-select">
                                    <span>Selecionar Máquina:</span>
                                    <select name="" id="">
                                        <option value="">Máquina 1</option>
                                    </select>
                                </div>      
                                <div class="box-select">
                                    <span>Visualizar conexões por:</span>
                                    <select name="" id="">
                                        <option value="">Dia</option>
                                        <option value="">Mês</option>
                                        <option value="">Ano</option>
                                    </select>
                                </div>                      
                            </div>
                        </div>
                        <div class="container-conexao">
                            <div class="header-conexao">
                                <span class="span-conexao">Relatório de Conexões</span>
                            </div>
                            <div class="table-conexao">
                                <div class="tuple-conexao">
                                    <div class="container-ip">
                                        <span>198.123.123.123</span>
                                    </div>
                                    <div class="container-dthora">
                                        <span>07/11/2023 11:22</span>
                                    </div>
                                    <div class="container-registro">
                                        <span>Registrado</span>
                                    </div>
                                    <div class="container-maquina">
                                        <span>Máquina 1</span>
                                    </div>
                                </div>
                                <div class="tuple-conexao">
                                    <div class="container-ip">
                                        <span>198.123.123.123</span>
                                    </div>
                                    <div class="container-dthora">
                                        <span>07/11/2023 11:22</span>
                                    </div>
                                    <div class="container-registro">
                                        <span>Registrado</span>
                                    </div>
                                    <div class="container-maquina">
                                        <span>Máquina 1</span>
                                    </div>
                                </div>
                                <div class="tuple-conexao">
                                    <div class="container-ip">
                                        <span>198.123.123.123</span>
                                    </div>
                                    <div class="container-dthora">
                                        <span>07/11/2023 11:22</span>
                                    </div>
                                    <div class="container-registro">
                                        <span>Registrado</span>
                                    </div>
                                    <div class="container-maquina">
                                        <span>Máquina 1</span>
                                    </div>
                                </div>
                                <div class="tuple-conexao">
                                    <div class="container-ip">
                                        <span>198.123.123.123</span>
                                    </div>
                                    <div class="container-dthora">
                                        <span>07/11/2023 11:22</span>
                                    </div>
                                    <div class="container-registro">
                                        <span>Registrado</span>
                                    </div>
                                    <div class="container-maquina">
                                        <span>Máquina 1</span>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>




</body>

</html>

<script>

var menu = 0;

function mostrarMenu() {
    var drop_menu = document.getElementById('drop_menu'); 

    if (menu === 0) {
        drop_menu.style.display = 'flex';
        menu = 1;
    } else {
        drop_menu.style.display = 'none';
        menu = 0;
    }
}


    verificarAdmin()

function voltarHome() {
    window.location = '../index.html'
}

b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

cargo = sessionStorage.CARGO_USUARIO

gerenciarUsuarios = document.getElementById("gerenciar-usuarios")
console.log(gerenciarUsuarios)

gerenciarCirurgias = document.getElementById("gerenciar-cirurgias")
console.log(gerenciarCirurgias)

// if(cargo !== "Admin"){
//     gerenciarUsuarios.style = 'display: none'
// }

if (cargo !== "Atendente" && cargo !== "Admin") {
    gerenciarCirurgias.style = 'display: none'
}

var idHospital = sessionStorage.ID_HOSPITAL;
var fkRobo = 1;

function buscarDadosRede(fkRobo) {
        fetch(`/rede/buscarDadosRede/${fkRobo}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta não foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log("Objetos da Resposta:", (resposta))
                exibirDadosRede(resposta)
                plotarGraficosRede(resposta)
            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });
    }


   function exibirDadosRede(dadosRede){
    const statusRede = dadosRede.statusRede
    const latenciaRede = dadosRede.latenciaRede
    const bytesEnviados = dadosRede.bytesEnviados
    const bytesRecebidos = dadosRede.bytesRecebidos
    const velocidadeRede = dadosRede.velocidadeRede

    const divRelatorioGeral = document.querySelector(".box-kpi-data")
    const listaElementos = divRelatorioGeral.children
    const spanLatencia = listaElementos[1].childNodes[1]
    const spanVelocidadeRede = listaElementos[1].childNodes[3]
    const spanBytesEnviados =  listaElementos[3].childNodes[1]
    const spanBytesRecebidos =  listaElementos[3].childNodes[3]

    spanLatencia.textContent = latenciaRede[latenciaRede.length - 1].dado
    spanVelocidadeRede.textContent = velocidadeRede[velocidadeRede.length -1].dado
    spanBytesEnviados.textContent = bytesEnviados[bytesEnviados.length -1].dado
    spanBytesRecebidos.textContent = bytesRecebidos[bytesRecebidos.length -1].dado
   }

   buscarDadosRede(fkRobo)

   

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGraficoRede(resposta) {
        graficoLatencia(resposta.latenciaRede, fkRobo)
        graficoVelocidade(resposta.latenciaRede, fkRobo)
    }

    function graficoLatencia(latenciaRede, fkRobo) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Latência',
                data: [],
                borderWidth: 3,
                tension: 0.1,
                fill: false,
                showLine: true,
                borderColor: 'rgb(0,255,0)',
                backgroundColor: 'rgb(0,255,0)'
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < latenciaRede.length; i++) {
            labels.push(latenciaRede[i].HorarioFormatado);
            dados.datasets[0].data.push(latenciaRede[i].dado);
           
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Adicionando gráfico criado em div na tela
        const graficolm35 = document.getElementById(`lm35Temperatura`)
        let myChartLM35 = new Chart(graficolm35,
            {
                type: 'line',
                data: dados,
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            }

        );

        setTimeout(() => atualizarGraficoLM35(placa, dados, myChartLM35), 5000);
    }

    


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas,

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGraficoLM35(placa, dados, myChartLM35) {
        fetch(`/medidas/tempo-real-Graficos/${placa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    // obterdados(placa);
                    // alertar(novoRegistro, placa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(JSON.stringify(dados));

                    // let avisoCaptura = document.getElementById(`avisoCaptura${placa}`)
                    // avisoCaptura.innerHTML = ""
                    if (novoRegistro[0].data_formatado == dados.labels[dados.labels.length - 1]) {
                        console.log(dados + ' <= Aqui Estão os dados')
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Não há novos dados")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].data_formatado)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].data_formatado); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de umidade
                        myChartLM35.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoLM35(placa, dados, myChartLM35), 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoLM35(placa, dados, myChartLM35), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function atualizarGraficoDHT11(placa, dados, myChartDHT11) {
        fetch(`/medidas/tempo-real-Graficos/${placa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    // obterdados(placa);
                    // alertar(novoRegistro, placa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log('dados' + dados);

                    // let avisoCaptura = document.getElementById(`avisoCaptura${placa}`)
                    // avisoCaptura.innerHTML = ""
                    console.log(novoRegistro)
                    if (novoRegistro[1].data_formatado == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Não há novos dados")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[1].data_formatado + 'umidade')
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1] + 'umidade')
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[1].data_formatado); // incluir um novo momento
                        console.log(novoRegistro[1].umidade)
                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[1].umidade); // incluir uma nova medida de umidade
                        myChartDHT11.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoDHT11(placa, dados, myChartDHT11), 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoDHT11(placa, dados, myChartDHT11), 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

</script>