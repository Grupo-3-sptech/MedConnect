<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedConnect | Dashboard </title>

    <link rel="stylesheet" href="./css/dash-danilo.css">
    <!-- <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script> -->

    <link rel="shortcut icon" href="../Img/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <script src="js/graficoMaquinas.js"></script>
    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/validacoesUsuario.js"></script>
    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <div class="principal">
        <div class="sidebar">
            <div class="content-sidebar">
                <div class="logo-sidebar">
                    <img src="../Img/logo horizontal sem fundo.png" alt="">
                </div>

                <div class="options-sidebar">
                    <div class="opt">
                        <img src="../Img/icons8-grÃ¡fico-combinado-30.png" alt="">
                        <a href="dashboard.html">Dashboard Geral</a>
                    </div>

                    <div style="position: relative;" class="opt" id="aqui">
                        <img src="../Img/icons8-robÃ´-48.png" alt="">
                        <a href="#">Dashboard RÃ´bos</a>
                        <img onclick="mostrarMenu()" style="margin-left: 7px; cursor: pointer;"
                            src="./Img/icons8-mais-40.png" alt="">
                        <div style="display: none;" id="drop_menu" class="drop-menu">
                            <div class="item-menu">
                                <a href="dash_bianca.html">Dash Bianca</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_boos.html">Dash Boos</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_enzo.html">Dash Enzo</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_kayky.html">Dash Kayky</a>
                            </div>

                            <div class="item-menu">
                                <a href="dash_danilo.html">Dash Danilo</a>
                            </div>
                        </div>
                    </div>

                    <div class="opt" id="gerenciarUsuarios">
                        <img src="../Img/icons8-usuÃ¡rio-30.png" id="diminuir" alt="">
                        <a href="dash-gerenciar-users.html">Gerenciar UsuÃ¡rios</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-usuÃ¡rio-30.png" id="diminuir" alt="">
                        <a href="perfil.html">Perfil</a>
                    </div>

                    <div class="opt" id="gerenciar-cirurgias">
                        <img src="Img/icons8-hospital-50.png" id="diminuir" alt="">
                        <a href="cadastrar-cirurgia.html">Gerenciar Cirurgia</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-assistente-48.png" alt="">
                        <a href="dash-suporte.html">Suporte</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-alerta-30.png" alt="">
                        <a href="#">Chamado</a>
                    </div>
                </div>

                <div class="quit-button">
                    <div class="opt">
                        <img src="../Img/icons8-sair-30.png" alt="">
                        <a href="index.html" onclick="deslogar()">Log Out</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" style="height: fit-content;">

            <div class="header-content">
                <div class="navbar-header" style="height: 10vh;">
                    <h3>Dashboard Danilo</h3>
                    <p>OlÃ¡, <span style="font-weight: bolder;" id="b_usuario"></span></p>
                </div>
            </div>
            <div class="header-before2">
                <div class="maquinas" style="height: 85vh;">
                    <div class="box-situacao-geral">
                        <div class="container-cirurgia">
                            <h3>Suas prÃ³ximas Cirurgias do dia:</h3>
                            <div class="container-select">
                                <select class="select-cirurgias" id="slc-cirurgia">
                                    <option value="">21/11/2023 - 14:00:00 - Maquina 1</option>
                                    <option value="">21/11/2023 - 14:00:00 - Maquina 2</option>
                                    <option value="">21/11/2023 - 14:00:00 - Maquina 1</option>
                                </select>
                                <div class="select-cirurgias">
                                    <p>Robos Ativos ðŸŸ¢</p>
                                    <select name="maquinas-ligadas" id="maquinas-ativas">
                                    </select>
                                </div>
                            </div>

                        </div>
                        <div class="container-situacao-geral">
                            <div class="heading-situacao-geral">
                                <div class="container-span">
                                    <span>SituaÃ§Ã£o Geral dos componentes</span>
                                </div>
                                <div class="container-color-ball">
                                    <div class="color-ball"></div>
                                </div>
                            </div>
                            <div class="card-situacao-geral">
                                <div class="tipo-dado-situacao-geral">
                                    <div class="tipo-dado">Internet (LatÃªncia)</div>
                                    <div class="tipo-dado">RAM</div>
                                    <div class="tipo-dado">Disco</div>
                                    <div class="tipo-dado">CPU</div>
                                    <div class="tipo-dado">Temperatura </div>
                                </div>
                                <div class="dado-situacao-geral">
                                    <span class="dado"></span>
                                    <span class="dado"></span>
                                    <span class="dado"></span>
                                    <span class="dado"></span>
                                    <span class="dado"></span>
                                </div>

                                <div class="dado-estado-geral">
                                    <span class="estado" id="estadoInternet"></span>
                                    <span class="estado" id="estadoRam"></span>
                                    <span class="estado" id="estadoDisco"></span>
                                    <span class="estado" id="estadoCpu"></span>
                                    <span class="estado" id="estadoTemperatura"></span>
                                </div>

                            </div>
                        </div>
                    </div>


                    <div class="box-kpis">

                        <div class="container-kpis">

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador red"></div>
                                    <div class="conteudo-kpi">
                                        <p>LatÃªncia de Rede nas Ãºltimas 24h </p>
                                        <h2 id="dado-kpi">20%</h2>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador green"></div>
                                    <div class="conteudo-kpi">
                                        <p>Porcentagem de Uso de RAM nas Ãºltimas 24h</p>
                                        <h2 id="dado-kpi" class="dado"></h2>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador green"></div>
                                    <div class="conteudo-kpi">
                                        <p>Porcentagem de de uso Disco nas ultimas 24h</p>
                                        <h2 id="dado-kpi">42Â°</h2>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="container-kpis">

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador green"></div>
                                    <div class="conteudo-kpi">
                                        <p>Porcentagem de Uso de CPU nas Ãºltimas 24h</p>
                                        <h2 id="dado-kpi">20 ms</h2>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador red"></div>
                                    <div class="conteudo-kpi">
                                        <p>Qtd de Cirurgias nos Ãºltimos 30 dias</p>
                                        <h2 id="dado-kpi">32</h2>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi">
                                <div class="container-kpi">
                                    <div class="indicador red"></div>
                                    <div class="conteudo-kpi">
                                        <p>Cirurgias bem sucedidas</p>
                                        <h2 id="dado-kpi">31</h2>
                                    </div>
                                </div>
                            </div>

                        </div>



                    </div>
                </div>
            </div>
        </div>
    </div>





</body>

</html>

<script>

    var menu = 0;

    function mostrarMenu() {
        var drop_menu = document.getElementById('drop_menu');

        if (menu === 0) {
            drop_menu.style.display = 'flex';
            menu = 1;
        } else {
            drop_menu.style.display = 'none';
            menu = 0;
        }
    }


    verificarAdmin()

    function voltarHome() {
        window.location = '../index.html'
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    cargo = sessionStorage.CARGO_USUARIO


    // if(cargo !== "Admin"){
    //     gerenciarUsuarios.style = 'display: none'
    // }

    // if (cargo !== "Atendente" && cargo !== "Admin") {
    //     gerenciarCirurgias.style = 'display: none'
    // }

    var idHospital = sessionStorage.ID_HOSPITAL;
    window.onload = async function () {
        await buscarMaquinas(idHospital);
    };

    async function buscarMaquinas(idHospital) {
        fetch(`/robo/listar/${idHospital}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao fazer a solicitaÃ§Ã£o GET');
                }
                return response.json();
            }).then(data => {

                console.log(data)

                maquinas = data;

                var selectMaquinasAtivas = document.getElementById("maquinas-ativas");

                // Itera sobre o array de empresas e cria as opÃ§Ãµes do select
                for (let i = 0; i < maquinas.length; i++) {
                    const maquina = maquinas[i];

                    const optionElement = document.createElement('option');
                    optionElement.value = maquina.idRobo;
                    optionElement.text = "Robo " + (i + 1);
                    selectMaquinasAtivas.appendChild(optionElement);
                    optionElement.setAttribute('data-info', maquina.idProcess);
                }

            });
    }

    buscarUltimosAlertas()
    function buscarUltimosAlertas() {
        fetch(`/alertas/buscarUltimaMedida`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta nÃ£o foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log(`Objetos com Alertas:`, resposta);
                validarEstadoComponentes(resposta.critico, "Perigo")
                validarEstadoComponentes(resposta.urgente, "AtenÃ§Ã£o")

            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });

    }

    function validarEstadoComponentes(alerta, estado) {
        const elementoEstadoInternet = document.querySelector("#estadoInternet")
        const elementoEstadoRam = document.querySelector("#estadoRam")
        const elementoEstadoDisco = document.querySelector("#estadoDisco")
        const elementoEstadoCpu = document.querySelector("#estadoCpu")
        var elementoEstadoTemperatura = document.querySelector("#estadoTemperatura")


        var estadoInternet = "EstÃ¡vel"
        var estadoRam = "EstÃ¡vel"
        var estadoDisco = "EstÃ¡vel"
        var estadoCpu = "EstÃ¡vel"
        var estadoTemperatura = "EstÃ¡vel"

        elementoEstadoInternet.classList.add("font-green")
        elementoEstadoRam.classList.add("font-green")
        elementoEstadoDisco.classList.add("font-green")
        elementoEstadoCpu.classList.add("font-green")
        elementoEstadoTemperatura.classList.add("font-green")

        if (Object.values(alerta).length > 0) {
            for (let i = 0; i <= Object.values(alerta).length; i++) {

                if (Object.values(alerta)[i].nome_componente == "Latencia de Rede") {
                    estadoInternet = estado
                    elementoEstadoInternet.classList.remove("font-green")

                    if (estado == "Perigo") {
                        elementoEstadoInternet.classList.remove("font-orange")
                        elementoEstadoInternet.classList.add("font-red")
                    } else {
                        elementoEstadoInternet.classList.remove("font-red")
                        elementoEstadoInternet.classList.add("font-orange")
                    }
                }

                if (Object.values(alerta)[i].nome_componente == "Porcentagem da Memoria") {
                    estadoRam = estado
                    elementoEstadoRam.classList.remove("font-green")

                    if (estado == "Perigo") {
                        elementoEstadoRam.classList.remove("font-orange")
                        elementoEstadoRam.classList.add("font-red")
                    } else {
                        elementoEstadoRam.classList.remove("font-red")
                        elementoEstadoRam.classList.add("font-orange")
                    }
                }

                if (Object.values(alerta)[i].nome_componente == "Porcentagem do Disco") {
                    estadoDisco = estado
                    elementoEstadoDisco.classList.remove("font-green")

                    if (estado == "Perigo") {
                        elementoEstadoDisco.classList.remove("font-orange")
                        elementoEstadoDisco.classList.add("font-red")
                    } else {
                        elementoEstadoDisco.classList.remove("font-red")
                        elementoEstadoDisco.classList.add("font-orange")
                    }
                }

                if (Object.values(alerta)[i].nome_componente == "Porcentagem da CPU") {
                    estadoCpu = estado
                    elementoEstadoCpu.classList.remove("font-green")

                    if (estado == "Perigo") {
                        elementoEstadoCpu.classList.remove("font-orange")
                        elementoEstadoCpu.classList.add("font-red")
                    } else {
                        elementoEstadoCpu.classList.remove("font-red")
                        elementoEstadoCpu.classList.add("font-orange")
                    }
                }

                // // if(Object.values(alerta)[i].nome_componente == "Temperatura da CPU") estadoTemperatura = estado
                elementoEstadoInternet.textContent = estadoInternet
                elementoEstadoRam.textContent = estadoRam
                elementoEstadoDisco.textContent = estadoDisco
                elementoEstadoCpu.textContent = estadoCpu
            }

        }

        elementoEstadoInternet.textContent = estadoInternet
        elementoEstadoRam.textContent = estadoRam
        elementoEstadoDisco.textContent = estadoDisco
        elementoEstadoCpu.textContent = estadoCpu
        // elementoEstadoTemperatura.textContent = estado
    }


    capturarComponentes(1)
    function capturarComponentes(fkRobo) {
        fetch(`/danilo/capturarComponentes/${fkRobo}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta nÃ£o foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log(`Objetos `, resposta)
                exibirDadosComponentes(
                    resposta.latencia,
                    resposta.ram,
                    resposta.disco,
                    resposta.cpu,
                    resposta.temperatura)
            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });
        
    }

    function exibirDadosComponentes(latencia, ram, disco, cpu, temperatura) {
        const listaElementosComponentes = document.querySelectorAll(".dado")
        listaElementosComponentes[0].textContent = `${Math.round(latencia[latencia.length - 1].dado)} ms`
        listaElementosComponentes[1].textContent = `${ram[ram.length - 1].dado} %`
        listaElementosComponentes[2].textContent = `${disco[disco.length - 1].dado} %`
        listaElementosComponentes[3].textContent = `${cpu[cpu.length - 1].dado} %`
        listaElementosComponentes[4].textContent = temperatura[temperatura.length - 1].dado
    }

    capturarKPIS(1)
    function capturarKPIS(fkRobo) {
        fetch(`/danilo/capturarKPIS/:${fkRobo}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta nÃ£o foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log(`Objetos 24 horas`, resposta)
                exibirDadosKPI(resposta.latencia, resposta.ram, resposta.disco, resposta.cpu)

            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });

    }

    function exibirDadosKPI(latencia, ram , disco, cpu){
        listaElementosKPIS = document.querySelectorAll("#dado-kpi")
        listaElementosKPIS[0].textContent = latencia[latencia.length - 1].dado
        listaElementosKPIS[1].textContent = ram[ram.length - 1].dado
        listaElementosKPIS[2].textContent = disco[disco.length-1].dado
        listaElementosKPIS[3].textContent = cpu[cpu.length - 1].dado
    }

</script>