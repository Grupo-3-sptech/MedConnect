<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedConnect | Gestão das Métricas</title>

    <link rel="stylesheet" href="css/gestao-metrica.css">
    <!-- <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script> -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.min.css'></link>  

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="buscarMetricas()">

    <div class="principal">
        <div class="sidebar">
            <div class="content-sidebar">
                <div class="logo-sidebar">
                    <img src="../Img/logo horizontal sem fundo.png" alt="">
                </div>

                <div class="options-sidebar">
                    <div class="opt">
                        <img src="Img/icons8-gráfico-combinado-30.png" alt="">
                        <a href="dashboard.html">Dashboard Geral</a>
                    </div>

                    <div class="opt">
                        <img src="Img/icons8-robô-48.png" alt="">
                        <a href="dash-robo.html">Dashboard Rôbos</a>
                    </div>

                    <div class="opt" id="gerenciar-usuarios">
                        <img src="Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="dash-gerenciar-users.html">Gerenciar Usuários</a>
                    </div>

                    <div class="opt">
                        <img src="Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="perfil.html">Perfil</a>
                    </div>

                    <div class="opt">
                        <img src="Img/icons8-hospital-50.png" id="diminuir" alt="">
                        <a href="cadastrar-cirurgia.html">Gerenciar Cirurgia</a>
                    </div>

                    <div class="opt" id="aqui">
                        <img src="Img/icons8-assistente-48.png" alt="">
                        <a href="dash-suporte.html">Suporte</a>
                    </div>

                    <div class="opt">
                        <img src="Img/icons8-alerta-30.png" alt="">
                        <a href="#">Chamado</a>
                    </div>
                </div>

                <div class="quit-button">
                    <div class="opt">
                        <img src="../Img/icons8-sair-30.png" alt="">
                        <a href="index.html">Log Out</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" style="height: 100vh;">
            <div class="header-content">
                <div class="navbar-header" style="height: 10vh;">
                    <h3>Gestão de Métricas</h3>
                    <p>Olá, <span style="font-weight: bolder;" id="b_usuario"></span></p>
                </div>
            </div>     
            <div class="metrica-content">
                <div class="box-metrica">
                    <div class="container-header">
                        <div class="metrica-header">
                            <span class="metrica-span">
                                Métricas
                            </span>
                        </div>
                    </div>
                    <div class="container-label">
                        <div class="box-height box-width-25 dark-green edge-left">
                            <span class="label">
                                Dado do componente
                            </span>
                        </div>
                        <div class="box-height box-width-14 yellow">
                            <span class="label box-height box-width-14">
                                Alerta
                            </span>
                        </div>
                        <div class="box-height box-width-14 orange">
                            <span class="label">
                                Urgente
                            </span>
                        </div>
                        <div class="box-height box-width-14 red">
                            <span class="label">
                                Critico
                            </span>
                        </div>
                        <div class="box-height box-width-14 dark-green edge-right">
                            <span class="label">
                                Tipo do Dado
                            </span>
                        </div>
                        <div class="box-height box-filter">
                            <span class="label-filter">
                                Pesquisar por
                            </span>
                            <select class="select-label" name="" id="">
                                <option value="">Todos</option>
                                <option value="">CPU</option>
                                <option value="">RAM</option>
                                <option value="">Disco</option>
                                <option value="">Rede</option>
                            </select>
                        </div>
                    </div>
                    <div class="container-table">
                    </div>
                </div>
            </div>
        </div>

</body>

</html>

<script>

    cargo = sessionStorage.CARGO_USUARIO

    gerenciarUsuarios = document.getElementById("gerenciar-usuarios")
    console.log(gerenciarUsuarios)

    if (cargo !== "Admin") {
        gerenciarUsuarios.style = 'display: none'
    }

    function voltarHome() {
        window.location = '../index.html'
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    function buscarMetricas() {
        fetch(`/metricas/buscarMetricas`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta não foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log("Cheguei aqui no HTML!")
                construirObjetoMetrica(resposta)
            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });
        }

        

        function updateMetricas(fkMetrica, alerta, urgente, critico) {
        fetch(`/metricas/updateMetricas/${fkMetrica}/${alerta}/${urgente}/${critico}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta não foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log("Cheguei aqui no HTML!")
            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });
        }


        function excluirMetrica(idMetrica) {
        fetch(`/metricas/updateMetricas/${idMetrica}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log(`A resposta não foi bem-sucedida. Status: ${response.status}`);
                    return Promise.reject('Erro na resposta do servidor');
                }
            })
            .then(resposta => {
                console.log("Cheguei aqui no HTML!")
            })
            .catch(err => {
                console.log(`Houve um erro no fetch dos dados: ${err}`);
            });
        }
        

        function construirObjetoMetrica(metricas){

            metricas.forEach(metrica => {
                var objetoMetrica = {
                    fkMetrica: metrica.fkMetrica,
                    idMetrica: metrica.idMetrica,
                    nome_componente: metrica.nome,
                    alertaAlerta: metrica.alerta,
                    alertaUrgente: metrica.urgente,
                    alertaCritico: metrica.critico,
                    unidade: metrica.unidade
                }

                criarElementosMetricas(objetoMetrica)
            });
                
            }

        function criarElementosMetricas(objetoMetrica){
           var nome_componente = objetoMetrica.nome_componente
           var alertaAlerta = objetoMetrica.alertaAlerta
           var alertaUrgente = objetoMetrica.alertaUrgente
           var alertaCritico = objetoMetrica.alertaCritico
           var tipo_dado = objetoMetrica.unidade
           var fkMetrica = objetoMetrica.fkMetrica
           var idMetrica = objetoMetrica.idMetrica

           var divContainerTuple = document.createElement("div")
           divContainerTuple.classList.add("container-tuple")
           divContainerTuple.id = fkMetrica
    
           var divComponente = document.createElement("div")
           divComponente.classList.add("box-tuple-data")
        
           var spanComponente = document.createElement("span")
           spanComponente.textContent = nome_componente
           divComponente.appendChild(spanComponente)

           var divAlerta = document.createElement("div")
           divAlerta.classList.add("box-tuple-alerta")
           
           var spanAlerta = document.createElement("div")
           spanAlerta.textContent = alertaAlerta
           divAlerta.appendChild(spanAlerta)
           spanAlerta.id = "span"

           var divAlertaUrgente = document.createElement("div")
           divAlertaUrgente.classList.add("box-tuple-urgente")
           
           var spanAlertaUrgente = document.createElement("span")
           spanAlertaUrgente.textContent = alertaUrgente
           divAlertaUrgente.appendChild(spanAlertaUrgente)
           spanAlertaUrgente.id = "span"

           var divAlertaCritico = document.createElement("div")
           divAlertaCritico.classList.add("box-tuple-critico")

           var spanAlertaCritico = document.createElement("span")
           spanAlertaCritico.textContent = alertaCritico
           divAlertaCritico.appendChild(spanAlertaCritico)
           spanAlertaCritico.id = "span"

           var divTipoDado = document.createElement("div")
           divTipoDado.classList.add("box-tuple-tipo-dado")
           
           var spanTipoDado = document.createElement("span")
           spanTipoDado.textContent = tipo_dado
           divTipoDado.appendChild(spanTipoDado)

           var divButtonEditar = document.createElement("div")
           divButtonEditar.classList.add("box-tuple-button")

           divButtonEditar.innerHTML =
           `
           <button id=${fkMetrica} class="btn-editar" onclick="editarMetrica(this.id)">
            Editar
           </button>
           `

           var divButtonExcluir = document.createElement("div")
           divButtonExcluir.classList.add("box-tuple-button")

           divButtonExcluir.innerHTML = 
           `
           <button id=${idMetrica} class="btn-excluir" onclick="excluirMetrica(this.id)">
            Excluir
            </button>
           `

           divContainerTuple.appendChild(divComponente)
           divContainerTuple.appendChild(divAlerta)
           divContainerTuple.appendChild(divAlertaUrgente)
           divContainerTuple.appendChild(divAlertaCritico)
           divContainerTuple.appendChild(divTipoDado)
           divContainerTuple.appendChild(divButtonEditar)
           divContainerTuple.appendChild(divButtonExcluir)

           var divContainerTable = document.querySelector(".container-table")
           divContainerTable.appendChild(divContainerTuple)
        }


        function editarMetrica(fkMetrica){
            const divContainerTuple = document.getElementById(`${fkMetrica}`)
            const elementosTuple = divContainerTuple.children
            const listaElementoValores = []

            let i = 1
            for (; i <= 3; i++){
                    var divElemento = elementosTuple[i]
                    var spanElemento = divElemento.querySelector("#span")
                    var valorSpanElemento = spanElemento.textContent
                    listaElementoValores.push(valorSpanElemento)

                    spanElemento.remove()
                    var inputDado = document.createElement("input")
                    inputDado.value = valorSpanElemento
                    inputDado.id = "input"
                    divElemento.appendChild(inputDado)
                }
                
                const divButtonEditar = elementosTuple[5]
                const buttonEditar = elementosTuple[5].childNodes[1]
                const buttonExcluir = elementosTuple[6].childNodes[1]
                
                buttonEditar.remove()
                buttonExcluir.remove()

                divButtonEditar.innerHTML =
                `
                <button id=${fkMetrica} class="btn-salvar" onclick="validarEdicao(this.id, [${listaElementoValores}])">
                    Salvar
                </button>
                `
            
            }

        function validarEdicao(fkMetrica, listaElementoValores){
            const listaValidacao = []
            const divContainerTable = document.getElementById(`${fkMetrica}`)
            const elementosTuple = divContainerTable.children

            let i = 1
            for (; i <= 3; i++){
                    var divElemento = elementosTuple[i]
                    var elementoInput = divElemento.querySelector("#input")
                    var valorElementoInput = elementoInput.value
                    listaValidacao.push(valorElementoInput)

                }
            
            i = 0
            for (; i < listaElementoValores.length -1; i++){
                var valorAntigo = Number(listaElementoValores[i])
                var valorModificado = Number(listaValidacao[i])

                var alerta = listaValidacao[0]
                var urgente = listaValidacao[1]
                var critico = listaValidacao[2]

                if(valorModificado != valorAntigo){
                    console.log(`Esse valor foi modificado: ${valorAntigo}`)
                    updateMetricas(fkMetrica, alerta, urgente, critico)
                    location.reload()
                    return 
                }
            }
        }
        
            
        

</script>
